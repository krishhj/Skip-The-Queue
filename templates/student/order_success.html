{% extends "base.html" %}

{% block title %}Order Success - SkipTheQueue{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow animate-scaleIn">
            <div class="card-body text-center p-5">
                <div class="success-animation mb-4">
                    <i class="bi bi-check-circle-fill display-1 text-success"></i>
                </div>
                <h2 class="text-gradient">Order Placed Successfully!</h2>
                <p class="text-muted">Order #{{ order.order_number }}</p>
                
                <div class="alert alert-info mt-4">
                    <h5><i class="bi bi-clock"></i> Pickup Time: {{ order.pickup_time }}</h5>
                </div>

                <!-- Order Timeline -->
                <div class="order-timeline my-4">
                    <div class="timeline-step {{ 'completed' if order.order_status in ['placed', 'confirmed', 'preparing', 'ready', 'picked_up'] else 'active' if order.order_status == 'placed' else '' }}">
                        <div class="timeline-icon">
                            <i class="bi bi-cart-check"></i>
                        </div>
                        <small>Placed</small>
                    </div>
                    <div class="timeline-step {{ 'completed' if order.order_status in ['confirmed', 'preparing', 'ready', 'picked_up'] else 'active' if order.order_status == 'confirmed' else '' }}">
                        <div class="timeline-icon">
                            <i class="bi bi-check2"></i>
                        </div>
                        <small>Confirmed</small>
                    </div>
                    <div class="timeline-step {{ 'completed' if order.order_status in ['preparing', 'ready', 'picked_up'] else 'active' if order.order_status == 'preparing' else '' }}">
                        <div class="timeline-icon">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <small>Preparing</small>
                    </div>
                    <div class="timeline-step {{ 'completed' if order.order_status in ['ready', 'picked_up'] else 'active' if order.order_status == 'ready' else '' }}">
                        <div class="timeline-icon">
                            <i class="bi bi-bell"></i>
                        </div>
                        <small>Ready</small>
                    </div>
                    <div class="timeline-step {{ 'completed' if order.order_status == 'picked_up' else 'active' if order.order_status == 'picked_up' else '' }}">
                        <div class="timeline-icon">
                            <i class="bi bi-box-arrow-up"></i>
                        </div>
                        <small>Picked Up</small>
                    </div>
                </div>

                <div class="my-4">
                    <h5>Your QR Code</h5>
                    <p class="text-muted">Show this QR code at pickup</p>
                    <div class="qr-code-container">
                        {% if order.qr_code_path %}
                            <img src="/{{ order.qr_code_path }}" 
                                 alt="Order QR Code" 
                                 class="img-fluid" 
                                 style="max-width: 300px; border-radius: 12px;"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBDb2RlPC90ZXh0Pjwvc3ZnPg==';">
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> QR Code not generated. Please contact support.
                            </div>
                        {% endif %}
                        
                        <!-- Fallback: Show order number for manual verification -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <p class="mb-1"><strong>Order Number:</strong></p>
                            <h4 class="text-primary mb-0">{{ order.order_number }}</h4>
                            <small class="text-muted">Show this to vendor if QR doesn't work</small>
                        </div>
                    </div>
                </div>

                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="mb-3">Order Details</h6>
                        <table class="table table-sm mb-0">
                            {% for item in order.order_items %}
                            <tr>
                                <td class="text-start">{{ item.menu_item.name }} x{{ item.quantity }}</td>
                                <td class="text-end">â‚¹{{ "%.2f"|format(item.price * item.quantity) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="fw-bold">
                                <td class="text-start">Total</td>
                                <td class="text-end text-primary">â‚¹{{ "%.2f"|format(order.total_amount) }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="mt-4" id="order-status">
                    <h6>Current Status: 
                        <span class="badge badge-gradient" id="status-badge">{{ order.order_status }}</span>
                    </h6>
                </div>

                <div class="mt-4">
                    <button onclick="window.print()" class="btn btn-outline-primary me-2">
                        <i class="bi bi-printer"></i> Print QR Code
                    </button>
                    <a href="{{ url_for('student_home') }}" class="btn btn-primary me-2">
                        <i class="bi bi-house"></i> Back to Home
                    </a>
                    <a href="{{ url_for('my_orders') }}" class="btn btn-outline-primary">
                        <i class="bi bi-bag-check"></i> View All Orders
                    </a>
                </div>
            </div>
        </div>

        <!-- Sustainability Impact -->
        <div class="sustainability-card mt-4">
            <div class="text-center">
                <div class="sustainability-icon mx-auto">
                    <i class="bi bi-tree"></i>
                </div>
                <h5 style="color: #065f46;">ðŸŒ± You're Making a Difference!</h5>
                <p class="mb-0" style="color: #047857;">
                    By pre-ordering, you helped prevent food waste and supported sustainable food preparation
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// Confetti animation on page load
window.addEventListener('load', () => {
    createConfetti();
});

function createConfetti() {
    const colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 3 + 's';
        confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 6000);
    }
}

// WebSocket for real-time updates
const socket = io();
socket.on('connect', function() {
    console.log('Connected to WebSocket');
});

socket.on('order_status_update', function(data) {
    if (data.order_id == {{ order.id }}) {
        const statusBadge = document.getElementById('status-badge');
        statusBadge.textContent = data.status;
        
        // Update timeline
        updateTimeline(data.status);
        
        // Show toast notification
        showToast(data.message, 'success');
    }
});

function updateTimeline(status) {
    const steps = document.querySelectorAll('.timeline-step');
    const statuses = ['placed', 'confirmed', 'preparing', 'ready', 'picked_up'];
    const currentIndex = statuses.indexOf(status);
    
    steps.forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index < currentIndex) {
            step.classList.add('completed');
        } else if (index === currentIndex) {
            step.classList.add('active');
        }
    });
}

function showToast(message, type) {
    const toastEl = document.createElement('div');
    toastEl.className = `toast toast-${type} show`;
    toastEl.innerHTML = `
        <div class="toast-body d-flex align-items-center gap-2">
            <i class="bi bi-bell fs-5"></i>
            <span>${message}</span>
        </div>
    `;
    document.getElementById('toastContainer').appendChild(toastEl);
    setTimeout(() => toastEl.remove(), 5000);
}

// Success animation
const successIcon = document.querySelector('.success-animation i');
successIcon.style.animation = 'bounce 0.6s ease';

// Debug: Log QR code path
console.log('QR Code Path: {{ order.qr_code_path }}');
</script>

<style>
.success-animation i {
    animation: bounce 0.6s ease;
}

@media print {
    body * {
        visibility: hidden;
    }
    .qr-code-container, .qr-code-container * {
        visibility: visible;
    }
    .qr-code-container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }
}
</style>
{% endblock %}