{% extends "base.html" %}

{% block title %}Orders - SkipTheQueue{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-check"></i> Orders</h2>
    <div class="btn-group">
        <a href="{{ url_for('vendor_orders', status='all') }}" 
           class="btn btn-sm btn-outline-primary {{ 'active' if status_filter == 'all' else '' }}">All</a>
        <a href="{{ url_for('vendor_orders', status='placed') }}" 
           class="btn btn-sm btn-outline-primary {{ 'active' if status_filter == 'placed' else '' }}">Placed</a>
        <a href="{{ url_for('vendor_orders', status='confirmed') }}" 
           class="btn btn-sm btn-outline-primary {{ 'active' if status_filter == 'confirmed' else '' }}">Confirmed</a>
        <a href="{{ url_for('vendor_orders', status='preparing') }}" 
           class="btn btn-sm btn-outline-primary {{ 'active' if status_filter == 'preparing' else '' }}">Preparing</a>
        <a href="{{ url_for('vendor_orders', status='ready') }}" 
           class="btn btn-sm btn-outline-primary {{ 'active' if status_filter == 'ready' else '' }}">Ready</a>
    </div>
</div>

{% if orders %}
<div class="row">
    {% for order in orders %}
    <div class="col-12 mb-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>Order #{{ order.order_number }}</h5>
                        <p class="mb-1">
                            <strong>Customer:</strong> {{ order.customer.full_name }}<br>
                            <strong>Phone:</strong> {{ order.customer.phone }}<br>
                            <strong>Pickup Time:</strong> {{ order.pickup_time }}<br>
                            <strong>Payment:</strong> {{ order.payment_method|upper }}
                            {% if order.payment_status == 'paid' %}
                                <span class="badge bg-success">Paid</span>
                            {% elif order.payment_status == 'cod' %}
                                <span class="badge bg-warning">COD</span>
                            {% endif %}
                        </p>
                        
                        <hr>
                        
                        <h6>Items:</h6>
                        <ul>
                            {% for item in order.order_items %}
                            <li>{{ item.menu_item.name }} x{{ item.quantity }}</li>
                            {% endfor %}
                        </ul>
                        
                        {% if order.special_instructions %}
                        <div class="alert alert-info">
                            <strong>Special Instructions:</strong> {{ order.special_instructions }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        <h4 class="text-primary">â‚¹{{ "%.2f"|format(order.total_amount) }}</h4>
                        <p class="text-muted">{{ order.created_at.strftime('%d %b %Y, %I:%M %p') }}</p>
                        
                        <div class="mb-3">
                            <label class="form-label">Update Status:</label>
                            <select class="form-select form-select-sm" onchange="updateStatus({{ order.id }}, this.value)">
                                <option value="placed" {{ 'selected' if order.order_status == 'placed' else '' }}>Placed</option>
                                <option value="confirmed" {{ 'selected' if order.order_status == 'confirmed' else '' }}>Confirmed</option>
                                <option value="preparing" {{ 'selected' if order.order_status == 'preparing' else '' }}>Preparing</option>
                                <option value="ready" {{ 'selected' if order.order_status == 'ready' else '' }}>Ready</option>
                                <option value="completed" {{ 'selected' if order.order_status == 'completed' else '' }}>Completed</option>
                            </select>
                        </div>
                        
                        <a href="tel:{{ order.customer.phone }}" class="btn btn-sm btn-success w-100">
                            <i class="bi bi-telephone"></i> Call Customer
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h3 class="mt-3">No orders found</h3>
</div>
{% endif %}

<script>
function updateStatus(orderId, newStatus) {
    fetch('/vendor/update-order-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Order status updated successfully!');
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

const socket = io();
socket.on('new_order', function(data) {
    alert('New order received: ' + data.order_number);
    location.reload();
});
</script>
{% endblock %}